---
import '../styles/app.css';
import SearchBar from '../components/SearchBar.astro';
import Sidebar from '../components/Sidebar.astro';
import { Icon } from 'astro-icon/components';
import { releaseOptions } from '../lib/release-config';
import { withBasePath } from '../lib/paths';

export interface Props {
  title: string;
  basePath: string;
  release: string;
  pluginData: { pluginSlots: any[]; mfes: any[]; lastUpdated?: string };
  filtersData: { filters: any[]; lastUpdated?: string };
  eventsData: { events: any[]; lastUpdated?: string };
  showSidebar?: boolean;
  currentMfeId?: string;
  currentSlotId?: string;
  currentEventId?: string;
  currentFilterId?: string;
  showEvents?: boolean;
  showFilters?: boolean;
  lastUpdated?: string;
}

const {
  title,
  basePath,
  release,
  pluginData,
  filtersData,
  eventsData,
  showSidebar = false,
  currentMfeId,
  currentSlotId,
  currentEventId,
  currentFilterId,
  showEvents = false,
  showFilters = false,
  lastUpdated,
} = Astro.props as Props;

const effectiveLastUpdated =
  lastUpdated ?? pluginData.lastUpdated ?? filtersData.lastUpdated ?? eventsData.lastUpdated;

const formattedLastUpdated = effectiveLastUpdated
  ? new Date(effectiveLastUpdated).toLocaleString(undefined, {
      year: 'numeric',
      month: 'short',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
    })
  : null;

const normalizedBasePath = basePath.endsWith('/') ? basePath.slice(0, -1) : basePath;
const currentPath = Astro.url.pathname;
const pathSuffix = currentPath.startsWith(normalizedBasePath)
  ? currentPath.slice(normalizedBasePath.length) || '/'
  : '/';
const normalizedSuffix = pathSuffix.startsWith('/') ? pathSuffix : `/${pathSuffix}`;

const releaseLinks = releaseOptions.map((option) => {
  const optionBase = option.basePath.endsWith('/') ? option.basePath.slice(0, -1) : option.basePath;
  const targetPath = normalizedSuffix === '/' ? optionBase : `${optionBase}${normalizedSuffix}`;
  return { ...option, targetPath };
});

const navItems = [
  { href: '/mfes', label: 'MFE Slots', icon: 'tabler:puzzle' },
  { href: '/filters', label: 'Filters', icon: 'tabler:filter-code' },
  { href: '/events', label: 'Events', icon: 'tabler:bell' },
  { href: '/about', label: 'About', icon: 'tabler:info-circle' },
];

const isNavActive = (href: string) =>
  normalizedSuffix === href || (href !== '/' && normalizedSuffix.startsWith(`${href}/`));
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>{title} | Open edX Plugins System Catalog</title>
  </head>
  <body class="catalog-page bg-base-200 text-base-content">
    <header class="catalog-header sticky top-0 z-50 border-b border-base-300 bg-base-100/95 backdrop-blur">
      <div class="navbar mx-auto max-w-[1440px] gap-3 px-4 py-2">
        <div class="navbar-start w-auto flex-none min-w-0 gap-2">
          <a href={withBasePath(basePath, '/')} class="catalog-brand btn btn-ghost min-h-0 px-2 normal-case text-base sm:text-lg">
            <span class="catalog-brand-icon inline-flex size-8 items-center justify-center rounded-full border border-primary/25 bg-primary/10 text-primary">
              <Icon name="tabler:plug" width="1.05rem" height="1.05rem" />
            </span>
            <span class="hidden xl:inline">Open edX Plugins System Catalog</span>
            <span class="xl:hidden">Open edX Catalog</span>
          </a>
          <div class="hidden md:block">
            <select
              id="release-select"
              class="select select-bordered select-sm w-36"
              aria-label="Select release"
              onchange="window.location.href = this.value"
            >
              {releaseLinks.map((option) => (
                <option value={option.targetPath} selected={option.slug === release}>
                  {option.label}
                </option>
              ))}
            </select>
          </div>
        </div>

        <div class="navbar-center hidden flex-1 justify-stretch lg:flex">
          <SearchBar
            pluginData={pluginData}
            filtersData={filtersData}
            eventsData={eventsData}
            basePath={basePath}
          />
        </div>

        <div class="navbar-end w-auto flex-none gap-1">
          <div class="hidden lg:flex lg:items-center lg:gap-1">
            {navItems.map((item) => (
              <a
                href={withBasePath(basePath, item.href)}
                class={`catalog-nav-link btn btn-ghost btn-sm ${isNavActive(item.href) ? 'btn-active' : ''}`}
              >
                <Icon name={item.icon} width="1em" height="1em" is:inline />
                {item.label}
              </a>
            ))}
          </div>
          <div class="dropdown dropdown-end lg:hidden">
            <div tabindex="0" role="button" class="btn btn-ghost btn-square btn-sm" aria-label="Open menu">
              <Icon name="tabler:menu-2" width="1.1rem" height="1.1rem" />
            </div>
            <ul tabindex="0" class="menu dropdown-content z-[1] mt-3 w-56 rounded-box border border-base-300 bg-base-100 p-2 shadow-lg">
              <li class="md:hidden">
                <label class="px-2 py-1 text-xs font-semibold uppercase tracking-wide text-base-content/70" for="release-select-mobile">
                  Release
                </label>
                <select
                  id="release-select-mobile"
                  class="select select-bordered select-sm w-full"
                  aria-label="Select release"
                  onchange="window.location.href = this.value"
                >
                  {releaseLinks.map((option) => (
                    <option value={option.targetPath} selected={option.slug === release}>
                      {option.label}
                    </option>
                  ))}
                </select>
              </li>
              {navItems.map((item) => (
                <li>
                  <a href={withBasePath(basePath, item.href)} class={isNavActive(item.href) ? 'active' : ''}>
                    <Icon name={item.icon} width="1em" height="1em" is:inline />
                    {item.label}
                  </a>
                </li>
              ))}
            </ul>
          </div>
        </div>
      </div>
      <div class="mx-auto max-w-[1440px] px-4 pb-3 lg:hidden">
        <SearchBar
          pluginData={pluginData}
          filtersData={filtersData}
          eventsData={eventsData}
          basePath={basePath}
        />
      </div>
    </header>

    <div class="catalog-shell mx-auto flex w-full max-w-[1440px] flex-1 gap-4 px-4 py-5">
      {showSidebar && (
        <div class="hidden w-80 shrink-0 lg:block">
          <Sidebar
            pluginData={pluginData}
            filtersData={filtersData}
            eventsData={eventsData}
            basePath={basePath}
            currentMfeId={currentMfeId}
            currentSlotId={currentSlotId}
            currentEventId={currentEventId}
            currentFilterId={currentFilterId}
            showEvents={showEvents}
            showFilters={showFilters}
          />
        </div>
      )}

      <main class="catalog-main min-w-0 flex-1 space-y-1">
        <slot />
      </main>
    </div>

    <footer class="catalog-footer border-t border-base-300 bg-base-100">
      <div class="mx-auto max-w-[1440px] px-4 py-4 text-center text-sm text-base-content/80">
        <p>Auto-updating catalog of Open edX MFE plugin slots, backend events and filters.</p>
        {formattedLastUpdated && (
          <p class="mt-1">
            Last updated: <time>{formattedLastUpdated}</time>
          </p>
        )}
      </div>
    </footer>
  </body>
</html>
