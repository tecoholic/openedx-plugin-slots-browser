---
import BaseLayout from '../layouts/BaseLayout.astro';
import { Icon } from 'astro-icon/components';
import Breadcrumbs from '../components/Breadcrumbs.astro';
import { withBasePath } from '../lib/paths';

interface Props {
  release: { slug: string; basePath: string };
  pluginData: { pluginSlots: any[]; mfes: any[] };
  filtersData: { filters: any[] };
  eventsData: { events: any[] };
  mfeInfo: any;
  slots: any[];
  componentSlots?: {
    headerSlots: any[];
    footerSlots: any[];
  };
}

const { release, pluginData, filtersData, eventsData, mfeInfo, slots, componentSlots } = Astro.props as Props;
const basePath = release.basePath;
const missingPluginSlotsDir = mfeInfo?.hasPluginSlotsDir === false;
---

<BaseLayout
  title={mfeInfo.name}
  basePath={basePath}
  release={release.slug}
  pluginData={pluginData}
  filtersData={filtersData}
  eventsData={eventsData}
  showSidebar
  currentMfeId={mfeInfo.id}
>
  <section class="space-y-4">
    <Breadcrumbs
      items={[
        { label: 'MFEs', href: withBasePath(basePath, '/mfes') },
        { label: mfeInfo.name },
      ]}
    />
    <div class="flex flex-wrap items-start justify-between gap-3">
      <h1 class="text-4xl font-bold">{mfeInfo.name}</h1>
      <a href={mfeInfo.repository} target="_blank" rel="noopener noreferrer" class="btn btn-primary btn-sm">
        <Icon name="tabler:brand-github" width="1rem" height="1rem" /> View on GitHub
      </a>
    </div>
    {mfeInfo.description && <p class="text-base-content/75">{mfeInfo.description}</p>}
  </section>

  <section class="mt-6 space-y-4">
    <h2 class="text-2xl font-semibold">Plugin Slots ({slots.length})</h2>

    {missingPluginSlotsDir && (
      <div class="alert alert-error">
        <Icon name="tabler:alert-circle" width="1rem" height="1rem" />
        <span>
          This release branch does not include a `src/plugin-slots` directory for this MFE.
        </span>
      </div>
    )}

    {slots.length === 0 && !missingPluginSlotsDir ? (
      <div class="alert">
        <Icon name="tabler:info-circle" width="1rem" height="1rem" />
        <span>
          No plugin slots found in this MFE. The `src/plugin-slots` directory is present but has no
          slot entries this collector can parse.
        </span>
      </div>
    ) : (
      <div class="grid gap-4 md:grid-cols-2">
        {slots.map((slot) => (
          <article class="slot-card card border border-base-300 bg-base-100 shadow-sm">
            <div class="card-body gap-3">
              <h3 class="card-title text-base">
                <a href={withBasePath(basePath, `/mfes/${slot.mfeId}/slots/${slot.id}`)} class="link link-primary break-all">
                  {slot.id}
                </a>
              </h3>

              <div class="flex flex-wrap gap-1">
                {!slot.readmePresent && (
                  <span class="badge badge-error gap-1">
                    <Icon name="tabler:x" width="0.8rem" height="0.8rem" /> README missing
                  </span>
                )}
                {slot.hasExamples && (
                  <span class="badge badge-success gap-1">
                    <Icon name="tabler:code" width="0.8rem" height="0.8rem" /> Example code
                  </span>
                )}
                {slot.readmePresent && !slot.hasExamples && (
                  <span class="badge badge-warning gap-1">
                    <Icon name="tabler:alert-circle" width="0.8rem" height="0.8rem" /> Example missing
                  </span>
                )}
              </div>

              {slot.description && <p class="text-sm text-base-content/80">{slot.description}</p>}

              <div class="card-actions justify-end">
                <a href={slot.sourceUrl} target="_blank" rel="noopener noreferrer" class="btn btn-ghost btn-sm">
                  <Icon name="tabler:brand-github" width="0.95rem" height="0.95rem" />
                  View on GitHub
                </a>
              </div>
            </div>
          </article>
        ))}
      </div>
    )}
  </section>

  {componentSlots?.headerSlots && componentSlots.headerSlots.length > 0 && (
    <section class="mt-6 space-y-4">
      <h2 class="text-2xl font-semibold">Component: Header ({componentSlots.headerSlots[0]?.componentVersion || 'Unknown'})</h2>
      <div class="grid gap-4 md:grid-cols-2">
        {componentSlots.headerSlots.map((slot) => (
          <article class="slot-card card border border-base-300 bg-base-100 shadow-sm">
            <div class="card-body gap-3">
              <h3 class="card-title text-base">
                <a href={slot.sourceUrl} target="_blank" class="link link-primary break-all">
                  {slot.id}
                </a>
              </h3>

              <div class="flex flex-wrap gap-1">
                {!slot.readmePresent && (
                  <span class="badge badge-error gap-1">
                    <Icon name="tabler:x" width="0.8rem" height="0.8rem" /> README missing
                  </span>
                )}
                {slot.hasExamples && (
                  <span class="badge badge-success gap-1">
                    <Icon name="tabler:code" width="0.8rem" height="0.8rem" /> Example code
                  </span>
                )}
                {slot.readmePresent && !slot.hasExamples && (
                  <span class="badge badge-warning gap-1">
                    <Icon name="tabler:alert-circle" width="0.8rem" height="0.8rem" /> Example missing
                  </span>
                )}
              </div>

              {slot.description && <p class="text-sm text-base-content/80">{slot.description}</p>}

              <div class="card-actions justify-end">
                <a href={slot.sourceUrl} target="_blank" rel="noopener noreferrer" class="btn btn-ghost btn-sm">
                  <Icon name="tabler:brand-github" width="0.95rem" height="0.95rem" />
                  View on GitHub
                </a>
              </div>
            </div>
          </article>
        ))}
      </div>
    </section>
  )}

  {componentSlots?.footerSlots && componentSlots.footerSlots.length > 0 && (
    <section class="mt-6 space-y-4">
      <h2 class="text-2xl font-semibold">Component: Footer ({componentSlots.footerSlots[0]?.componentVersion || 'Unknown'})</h2>
      <div class="grid gap-4 md:grid-cols-2">
        {componentSlots.footerSlots.map((slot) => (
          <article class="slot-card card border border-base-300 bg-base-100 shadow-sm">
            <div class="card-body gap-3">
              <h3 class="card-title text-base">
                <a href={slot.sourceUrl} target="_blank" class="link link-primary break-all">
                  {slot.id}
                </a>
              </h3>

              <div class="flex flex-wrap gap-1">
                {!slot.readmePresent && (
                  <span class="badge badge-error gap-1">
                    <Icon name="tabler:x" width="0.8rem" height="0.8rem" /> README missing
                  </span>
                )}
                {slot.hasExamples && (
                  <span class="badge badge-success gap-1">
                    <Icon name="tabler:code" width="0.8rem" height="0.8rem" /> Example code
                  </span>
                )}
                {slot.readmePresent && !slot.hasExamples && (
                  <span class="badge badge-warning gap-1">
                    <Icon name="tabler:alert-circle" width="0.8rem" height="0.8rem" /> Example missing
                  </span>
                )}
              </div>

              {slot.description && <p class="text-sm text-base-content/80">{slot.description}</p>}

              <div class="card-actions justify-end">
                <a href={slot.sourceUrl} target="_blank" rel="noopener noreferrer" class="btn btn-ghost btn-sm">
                  <Icon name="tabler:brand-github" width="0.95rem" height="0.95rem" />
                  View on GitHub
                </a>
              </div>
            </div>
          </article>
        ))}
      </div>
    </section>
  )}

  <div class="mt-6">
    <a href={withBasePath(basePath, '/mfes')} class="btn btn-ghost btn-sm">Back to MFEs</a>
  </div>
</BaseLayout>
