---
import BaseLayout from '../layouts/BaseLayout.astro';
import { Icon } from 'astro-icon/components';
import { getReleaseData, getReleaseGrowthData } from '../lib/release-data';
import { withBasePath } from '../lib/paths';

interface Props {
  releaseSlug?: string;
}

const { releaseSlug } = Astro.props as Props;
const { release, pluginData, filtersData, eventsData } = getReleaseData(releaseSlug);
const basePath = release.basePath;

const slotCount = pluginData.pluginSlots.length;
const filterCount = filtersData.filters.length;
const eventCount = eventsData.events.length;
const lastUpdated = pluginData.lastUpdated;
const documentedCount = pluginData.pluginSlots.filter((slot) => slot.readmePresent).length;
const examplesCount = pluginData.pluginSlots.filter((slot) => slot.hasExamples).length;
const filterDomains = new Set(filtersData.filters.map((filter) => filter.category)).size;
const eventNamespaces = new Set(eventsData.events.map((event) => event.namespace)).size;
const releaseGrowthData = getReleaseGrowthData();
---

<BaseLayout
  title="Home"
  basePath={basePath}
  release={release.slug}
  pluginData={pluginData}
  filtersData={filtersData}
  eventsData={eventsData}
  lastUpdated={lastUpdated}
>
  <section class="home-hero hero rounded-box border border-base-300 bg-base-100">
    <div class="hero-content py-12 text-center">
      <div class="max-w-4xl space-y-5">
        <h1 class="text-4xl font-bold sm:text-5xl">Open edX Plugins System Catalog</h1>
        <p class="text-base leading-relaxed text-base-content/80 sm:text-lg">
          A continuously updated catalog of Open edX frontend plugin slots, backend filters, and
          events, with source links and documentation to help you extend and customize Open edX
          without forking core code.
        </p>
      </div>
    </div>
  </section>

  <section class="metrics-grid mt-8 grid gap-4 lg:grid-cols-3">
    <article class="metric-card card border border-base-300 bg-base-100 shadow-sm">
      <div class="card-body gap-4">
        <div class="flex items-center justify-between">
          <h2 class="card-title text-lg">Frontend Plugin Slots</h2>
          <Icon name="tabler:puzzle" class="text-primary" width="1.7rem" height="1.7rem" is:inline />
        </div>
        <p class="text-4xl font-bold text-primary">{slotCount}</p>
        <a
          href={withBasePath(basePath, '/mfes')}
          class="btn btn-primary btn-lg w-full text-base font-semibold shadow-lg shadow-primary/25 sm:w-fit"
        >
          Browse MFE Slots <Icon name="tabler:arrow-right" width="1rem" height="1rem" />
        </a>
        <div class="mt-auto space-y-1 border-t border-base-300/80 pt-3 text-xs text-base-content/65">
          <p class="flex items-center justify-between">
            <span class="uppercase tracking-wide">With README</span>
            <span class="font-semibold text-base-content/75">{documentedCount}</span>
          </p>
          <p class="flex items-center justify-between">
            <span class="uppercase tracking-wide">With Examples</span>
            <span class="font-semibold text-base-content/75">{examplesCount}</span>
          </p>
        </div>
      </div>
    </article>

    <article class="metric-card card border border-base-300 bg-base-100 shadow-sm">
      <div class="card-body gap-4">
        <div class="flex items-center justify-between">
          <h2 class="card-title text-lg">Backend Filters</h2>
          <Icon name="tabler:filter-code" class="text-secondary" width="1.7rem" height="1.7rem" is:inline />
        </div>
        <p class="text-4xl font-bold text-secondary">{filterCount}</p>
        <a
          href={withBasePath(basePath, '/filters')}
          class="btn btn-secondary btn-lg w-full text-base font-semibold shadow-lg shadow-secondary/25 sm:w-fit"
        >
          Browse Filters <Icon name="tabler:arrow-right" width="1rem" height="1rem" />
        </a>
        <div class="mt-auto space-y-1 border-t border-base-300/80 pt-3 text-xs text-base-content/65">
          <p class="flex items-center justify-between">
            <span class="uppercase tracking-wide">Domains</span>
            <span class="font-semibold text-base-content/75">{filterDomains}</span>
          </p>
        </div>
      </div>
    </article>

    <article class="metric-card card border border-base-300 bg-base-100 shadow-sm">
      <div class="card-body gap-4">
        <div class="flex items-center justify-between">
          <h2 class="card-title text-lg">Backend Events</h2>
          <Icon name="tabler:bell" class="text-accent" width="1.7rem" height="1.7rem" is:inline />
        </div>
        <p class="text-4xl font-bold text-accent">{eventCount}</p>
        <a
          href={withBasePath(basePath, '/events')}
          class="btn btn-accent btn-lg w-full text-base font-semibold shadow-lg shadow-accent/25 sm:w-fit"
        >
          Browse Events <Icon name="tabler:arrow-right" width="1rem" height="1rem" />
        </a>
        <div class="mt-auto space-y-1 border-t border-base-300/80 pt-3 text-xs text-base-content/65">
          <p class="flex items-center justify-between">
            <span class="uppercase tracking-wide">Namespaces</span>
            <span class="font-semibold text-base-content/75">{eventNamespaces}</span>
          </p>
        </div>
      </div>
    </article>
  </section>

  {release.slug === 'main' && (
    <section class="trend-card card mt-8 border border-base-300 bg-base-100 shadow-sm">
      <div class="card-body">
        <h2 class="card-title">Release Trends</h2>
        <p class="text-sm text-base-content/75">Counts of slots, filters, and events across releases.</p>
        <div class="h-80 w-full sm:h-96">
          <canvas
            id="release-growth-chart"
            data-growth-chart={JSON.stringify(releaseGrowthData)}
            role="img"
            aria-label="Bar chart of slots, filters, and events by release"
            class="h-full w-full"
          />
        </div>
      </div>
    </section>
  )}

  <section class="card mt-8 border border-base-300 bg-base-100 shadow-sm">
    <div class="card-body">
      <h2 class="card-title">Getting Started</h2>
      <p class="text-sm text-base-content/75">Short, curated notes with links to deeper dives.</p>
      <ul class="grid gap-4 lg:grid-cols-3">
        <li class="resource-card rounded-box border border-base-300 bg-base-200/70 p-4">
          <h3 class="mb-2 text-lg font-semibold">Frontend Plugin Implementation Guide</h3>
          <p class="mb-3 text-sm text-base-content/80">
            A complete guide that demonstrates how to customize Open edX micro-frontends using the
            Frontend Plugin Framework.
          </p>
          <a href="https://github.com/openedx/sample-plugin/tree/main/frontend" class="link link-primary inline-flex items-center gap-1">
            Learn more <Icon name="tabler:arrow-right" width="1rem" height="1rem" />
          </a>
        </li>
        <li class="resource-card rounded-box border border-base-300 bg-base-200/70 p-4">
          <h3 class="mb-2 text-lg font-semibold">How to use Open edX Filters?</h3>
          <p class="mb-3 text-sm text-base-content/80">
            Official documentation covering pipeline step implementation, hook, trigger, and
            testing.
          </p>
          <a href="https://docs.openedx.org/projects/openedx-filters/en/open-release-sumac.master/how-tos/using-filters.html" class="link link-primary inline-flex items-center gap-1">
            Learn more <Icon name="tabler:arrow-right" width="1rem" height="1rem" />
          </a>
        </li>
        <li class="resource-card rounded-box border border-base-300 bg-base-200/70 p-4">
          <h3 class="mb-2 text-lg font-semibold">Using Open edX Events</h3>
          <p class="mb-3 text-sm text-base-content/80">
            Official docs covering events: sending, receiving, and testing.
          </p>
          <a href="https://docs.openedx.org/projects/openedx-events/en/stable/how-tos/using-events.html" class="link link-primary inline-flex items-center gap-1">
            Learn more <Icon name="tabler:arrow-right" width="1rem" height="1rem" />
          </a>
        </li>
      </ul>
    </div>
  </section>

  <section class="contribute-alert alert alert-info mt-8">
    <Icon name="tabler:info-circle" width="1.1rem" height="1.1rem" />
    <span>
      Help improve this catalog via the
      <a href="https://github.com/tecoholic/openedx-plugin-slots-browser" target="_blank" rel="noopener" class="link link-primary">
        GitHub repository
      </a>.
    </span>
  </section>
</BaseLayout>

<script>
  async function initializeReleaseGrowthChart() {
    const chartCanvas = document.getElementById('release-growth-chart');
    if (!(chartCanvas instanceof HTMLCanvasElement) || !chartCanvas.dataset.growthChart) {
      return;
    }

    if (chartCanvas.dataset.chartInitialized === 'true') {
      return;
    }
    chartCanvas.dataset.chartInitialized = 'true';

    const {
      BarController,
      BarElement,
      CategoryScale,
      Chart,
      Legend,
      LinearScale,
      Tooltip,
    } = await import('chart.js');

    Chart.register(
      BarController,
      BarElement,
      CategoryScale,
      LinearScale,
      Tooltip,
      Legend,
    );

    const growthData = JSON.parse(chartCanvas.dataset.growthChart);
    const labels = growthData.map((point) => point.label);

    const chartData = {
      labels,
      datasets: [
        {
          label: 'MFE Plugin Slots',
          data: growthData.map((point) => point.slotCount),
          backgroundColor: '#155dfc',
          borderColor: '#155dfc',
          borderWidth: 1,
          borderRadius: 6,
        },
        {
          label: 'Filters',
          data: growthData.map((point) => point.filterCount),
          backgroundColor: '#00b5b6',
          borderColor: '#00b5b6',
          borderWidth: 1,
          borderRadius: 6,
        },
        {
          label: 'Events',
          data: growthData.map((point) => point.eventCount),
          backgroundColor: '#ef9f1c',
          borderColor: '#ef9f1c',
          borderWidth: 1,
          borderRadius: 6,
        },
      ],
    };

    const valueLabelsPlugin = {
      id: 'valueLabels',
      afterDatasetsDraw(chart) {
        const { ctx } = chart;
        ctx.save();
        ctx.font = '600 12px system-ui, -apple-system, sans-serif';
        ctx.fillStyle = '#374151';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'bottom';

        for (const datasetMeta of chart.getSortedVisibleDatasetMetas()) {
          const dataset = chart.data.datasets[datasetMeta.index];
          datasetMeta.data.forEach((barElement, index) => {
            const value = dataset.data[index];
            if (typeof value === 'number') {
              ctx.fillText(String(value), barElement.x, barElement.y - 4);
            }
          });
        }

        ctx.restore();
      },
    };

    new Chart(chartCanvas, {
      type: 'bar',
      data: chartData,
      plugins: [valueLabelsPlugin],
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        plugins: {
          legend: {
            position: 'bottom',
          },
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              precision: 0,
            },
          },
        },
      },
    });
  }

  document.addEventListener('DOMContentLoaded', initializeReleaseGrowthChart);
  document.addEventListener('astro:page-load', initializeReleaseGrowthChart);
</script>
