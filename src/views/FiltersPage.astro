---
import { Icon } from 'astro-icon/components';
import BaseLayout from '../layouts/BaseLayout.astro';
import { getReleaseData } from '../lib/release-data';
import { withBasePath } from '../lib/paths';
import 'simple-datatables/dist/style.css';

interface Props {
  releaseSlug?: string;
}

const { releaseSlug } = Astro.props as Props;
const { release, pluginData, filtersData, eventsData } = getReleaseData(releaseSlug);
const basePath = release.basePath;

const filters = filtersData.filters;
const categories = filtersData.categories;
const lastUpdated = filtersData.lastUpdated;
---

<BaseLayout
  title="Filters"
  basePath={basePath}
  release={release.slug}
  pluginData={pluginData}
  filtersData={filtersData}
  eventsData={eventsData}
  lastUpdated={lastUpdated}
  showSidebar
  showFilters
>
  <section class="space-y-4">
    <div class="flex flex-wrap items-center gap-2">
      <h1 class="text-4xl font-bold">Open edX Backend Filters</h1>
      <span class="badge badge-primary gap-1 py-3">
        <Icon name="tabler:filter-code" width="0.95rem" height="0.95rem" is:inline />
        {filters.length} Filters
      </span>
      <span class="badge badge-secondary gap-1 py-3">
        <Icon name="tabler:folder" width="0.95rem" height="0.95rem" is:inline />
        {categories.length} {categories.length === 1 ? 'Category' : 'Categories'}
      </span>
    </div>
    <p class="max-w-3xl text-base-content/75">
      Discover all available backend filters in Open edX. Filters let you hook into backend
      processes and customize behavior without modifying core code.
    </p>
  </section>

  <section class="mt-6 space-y-8">
    {categories.map((category) => {
      const categoryFilters = filters.filter((filter) => filter.category === category);
      return (
        <article class="card border border-base-300 bg-base-100 shadow-sm">
          <div class="card-body gap-4">
            <div>
              <h2 class="card-title text-2xl">
                {category.charAt(0).toUpperCase() + category.slice(1).replace('_', ' ')} Filters
              </h2>
              <p class="text-sm text-base-content/75">
                {category === 'learning' &&
                  'Filters related to course learning experience, enrollment, certificates, and dashboard rendering.'}
                {category === 'content_authoring' &&
                  'Filters related to course content authoring and management.'}
              </p>
            </div>

            <div class="overflow-x-auto rounded-box border border-base-300">
              <table class="table table-zebra filters-table" data-searchable="true" data-sortable="true">
                <thead>
                  <tr>
                    <th>Filter Name</th>
                    <th>Description</th>
                    <th>Source</th>
                  </tr>
                </thead>
                <tbody>
                  {categoryFilters.map((filter) => (
                    <tr>
                      <td class="max-w-md align-top">
                        <a href={withBasePath(basePath, `/filters/${filter.id}`)} class="link link-primary block">
                          {filter.name}
                        </a>
                        <code class="mt-2 inline-block rounded bg-base-200 px-2 py-1 text-xs">{filter.filterType}</code>
                      </td>
                      <td class="text-sm text-base-content/80">{filter.description}</td>
                      <td class="text-center">
                        <a href={filter.sourceUrl} target="_blank" rel="noopener noreferrer" class="btn btn-ghost btn-xs" aria-label={`View source for ${filter.name}`}>
                          <Icon name="tabler:external-link" width="0.95rem" height="0.95rem" />
                        </a>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </article>
      );
    })}
  </section>
</BaseLayout>

<script>
  async function initTables() {
    const { DataTable } = await import('simple-datatables');

    const tables = document.querySelectorAll('.filters-table[data-sortable="true"]');
    tables.forEach((table) => {
      if (table.dataset.initialized === 'true') {
        return;
      }

      table.dataset.initialized = 'true';
      new DataTable(table, {
        searchable: true,
        sortable: true,
        perPage: 50,
      });
    });
  }

  document.addEventListener('DOMContentLoaded', initTables);
  document.addEventListener('astro:page-load', initTables);
</script>
