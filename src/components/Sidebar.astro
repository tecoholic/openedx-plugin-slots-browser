---
import { Icon } from 'astro-icon/components';
import { withBasePath } from '../lib/paths';

export interface Props {
  pluginData: { pluginSlots: any[]; mfes: any[] };
  eventsData: { events: any[] };
  filtersData: { filters: any[] };
  basePath: string;
  currentMfeId?: string;
  currentSlotId?: string;
  currentEventId?: string;
  currentFilterId?: string;
  showEvents?: boolean;
  showFilters?: boolean;
}

const {
  pluginData,
  eventsData,
  filtersData,
  basePath,
  currentMfeId,
  currentSlotId,
  currentEventId,
  currentFilterId,
  showEvents = false,
  showFilters = false,
} = Astro.props as Props;

const eventsByNamespace = eventsData.events.reduce(
  (acc, event) => {
    if (!acc[event.namespace]) {
      acc[event.namespace] = [];
    }
    acc[event.namespace].push(event);
    return acc;
  },
  {} as Record<string, typeof eventsData.events>
);

const namespaces = Object.keys(eventsByNamespace).sort();

const filtersByCategory = filtersData.filters.reduce(
  (acc, filter) => {
    if (!acc[filter.category]) {
      acc[filter.category] = [];
    }
    acc[filter.category].push(filter);
    return acc;
  },
  {} as Record<string, typeof filtersData.filters>
);

const categories = Object.keys(filtersByCategory).sort();
---

<aside class="sidebar-flat card sticky top-24 max-h-[calc(100vh-7rem)] overflow-y-auto border border-base-300 bg-base-100 shadow-sm">
  <div class="card-body gap-2 p-3">
    {showFilters ? (
      <>
        <h3 class="px-2 text-xs font-semibold uppercase tracking-wider text-base-content/60">Filters by Category</h3>
        {categories.map((category) => {
          const catFilters = filtersByCategory[category];
          const isActive = Boolean(currentFilterId && catFilters.some((filter) => filter.id === currentFilterId));

          return (
            <details class={`collapse collapse-arrow bg-transparent ${isActive ? 'open' : ''}`} open={isActive}>
              <summary class="collapse-title min-h-0 py-2 pl-7 pr-2 text-sm font-medium">
                <div class="flex items-center justify-between gap-2">
                  <span class="truncate">{category.charAt(0).toUpperCase() + category.slice(1)}</span>
                  <span class="badge badge-primary badge-sm">{catFilters.length}</span>
                </div>
              </summary>
              <div class="collapse-content px-2 pb-2">
                <ul class="menu menu-sm gap-1 p-1">
                  {catFilters.map((filter) => (
                    <li>
                      <a href={withBasePath(basePath, `/filters/${filter.id}`)} class={currentFilterId === filter.id ? 'active' : ''}>
                        <span class="truncate text-xs">{filter.name}</span>
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            </details>
          );
        })}
      </>
    ) : showEvents ? (
      <>
        <h3 class="px-2 text-xs font-semibold uppercase tracking-wider text-base-content/60">Events by Domain</h3>
        {namespaces.map((namespace) => {
          const nsEvents = eventsByNamespace[namespace];
          const isActive = Boolean(currentEventId?.startsWith(namespace));

          return (
            <details class={`collapse collapse-arrow bg-transparent ${isActive ? 'open' : ''}`} open={isActive}>
              <summary class="collapse-title min-h-0 py-2 pl-7 pr-2 text-sm font-medium">
                <div class="flex items-center justify-between gap-2">
                  <span class="truncate">
                    {namespace
                      .replace(/-/g, ' ')
                      .split(' ')
                      .map((word: string) => word.charAt(0).toUpperCase() + word.slice(1))
                      .join(' ')}
                  </span>
                  <span class="badge badge-primary badge-sm">{nsEvents.length}</span>
                </div>
              </summary>
              <div class="collapse-content px-2 pb-2">
                <ul class="menu menu-sm gap-1 p-1">
                  {nsEvents.map((event) => (
                    <li>
                      <a href={withBasePath(basePath, `/events/${event.id}`)} class={currentEventId === event.id ? 'active' : ''}>
                        <span class="truncate text-xs">{event.eventName}</span>
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            </details>
          );
        })}
      </>
    ) : (
      <>
        <h3 class="px-2 text-xs font-semibold uppercase tracking-wider text-base-content/60">Frontend Apps</h3>
        {pluginData.mfes.map((mfe) => {
          const mfeSlots = pluginData.pluginSlots.filter((slot) => slot.mfeId === mfe.id);
          const isActive = currentMfeId === mfe.id;

          return (
            <details class={`collapse collapse-arrow bg-transparent ${isActive ? 'open' : ''}`} open={isActive}>
              <summary class="collapse-title min-h-0 py-2 pl-7 pr-2 text-sm font-medium">
                <div class="flex items-center justify-between gap-2">
                  <span class="truncate">{mfe.name}</span>
                  <span class="badge badge-primary badge-sm">{mfeSlots.length}</span>
                </div>
              </summary>
              <div class="collapse-content px-2 pb-2">
                <ul class="menu menu-sm gap-1 p-1">
                  {mfeSlots.map((slot) => (
                    <li>
                      <a href={withBasePath(basePath, `/mfes/${slot.mfeId}/slots/${slot.id}`)} class={currentSlotId === slot.id ? 'active' : ''}>
                        <span class="truncate text-xs">{slot.id}</span>
                        {!slot.readmePresent && (
                          <Icon name="tabler:alert-circle" class="text-error" width="0.95rem" height="0.95rem" title="README missing" />
                        )}
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            </details>
          );
        })}
      </>
    )}
  </div>
</aside>

<style>
  .sidebar-flat :global(.collapse) {
    border: none;
    border-radius: 0;
    box-shadow: none;
    background: transparent;
  }

  .sidebar-flat :global(.collapse-title) {
    border-radius: 0.45rem;
    transition: background-color 150ms ease;
  }

  .sidebar-flat :global(.collapse-arrow > .collapse-title::after),
  .sidebar-flat :global(.collapse-arrow > .collapse-title:after) {
    left: 0.55rem;
    right: auto;
    inset-inline-start: 0.55rem;
    inset-inline-end: auto;
  }

  .sidebar-flat :global(.collapse-title:hover) {
    background: color-mix(in oklab, var(--color-primary) 10%, transparent);
  }

  .sidebar-flat :global(details[open] > .collapse-title) {
    background: color-mix(in oklab, var(--color-primary) 14%, transparent);
  }

  .sidebar-flat :global(.menu) {
    border-radius: 0;
    background: transparent;
  }

  .sidebar-flat :global(.menu li > a) {
    border-radius: 0.35rem;
    background: transparent;
    transition: background-color 150ms ease;
  }

  .sidebar-flat :global(.menu li > a:hover) {
    background: color-mix(in oklab, var(--color-primary) 8%, transparent);
  }

  .sidebar-flat :global(.menu li > a.active) {
    background: color-mix(in oklab, var(--color-primary) 16%, transparent);
  }

  .sidebar-flat :global(.collapse-content) {
    position: relative;
    margin-left: 0.45rem;
    padding-left: 1rem;
  }

  .sidebar-flat :global(details[open] > .collapse-content::before) {
    content: "";
    position: absolute;
    left: 0.45rem;
    top: 0.2rem;
    bottom: 0.35rem;
    width: 1px;
    background: color-mix(in oklab, var(--color-primary) 26%, var(--color-base-300));
    opacity: 0.65;
  }
</style>
